# CSAPP

《深入理解计算机系统 第三版》 Computer Systems A Programmer's Perspective Third Edition

## 目录

1. [序](#序)
1. [第1章 计算机系统漫游](#第1章-计算机系统漫游)

## 序

1. 问题抽象、系统抽象和数据抽象是计算机类专业毕业生的核心能力，而本书担负起了系统抽象的重任。

## 第1章 计算机系统漫游

1. 信息就是位+上下文
    1. 源程序是由0和1组成的位（又称比特）序列
    1. 8个位为1字节
    1. 只由 ASCII 字符构成的文件称为文本文件，所有其他文件都称为二进制文件
    1. 系统中所有的信息都是由一串比特表示的，区分不同数据对象的唯一方法是我们读到这些数据对象时的上下文
1. 程序被其他程序翻译成不同的格式
    1. hello.c（源程序 文本文件）-> 预处理器（cpp）-> hello.i （修改了的源程序 文本文件） -> 编译器（ccl） -> hello.s（汇编程序 文本文件） -> 汇编器（as） -> hello.o （可重定位目标程序 二进制文件） and printf.o -> 链接器（ld） -> hello （可执行目标文件 二进制文件）
    1. 预处理阶段
        1. 将 #include 指令的内容插入到程序文本中等处理操作
    1. 编译阶段
        1. 将源程序翻译成汇编程序
    1. 汇编阶段
        1. 将汇编程序翻译成机器语言指令，把这些指令打包成可重定位目标程序 (relocatable object program)
    1. 链接阶段
        1. 链接不同的目标文件，得到可执行目标文件（简称可执行文件），可以被加载到内存中，由系统执行
1. 了解编译系统如何工作是大有益处的
1. 处理器读并解释存储在内存中的指令
1. 高速缓存至关重要
    1. 局部性原理，程序具有访问局部区域里的数据和代码的趋势
        1. 空间局部性、时间局部性
    1. L1 和 L2 高速缓存是用一种叫做静态随机访问存储器（SRAM）的硬件技术实现的
    1. 意识到高速缓存存储器存在的应用程序员能够利用高速缓存将程序的性能提高一个数量级
1. 存储设备形成层次结构
1. 操作系统管理硬件
    1. 操作系统有两个基本功能
        1. 防止硬件被失控的应用程序滥用
        1. 向应用程序提供简单一致的机制来控制复杂而又通常大不相同的低级硬件设备
    1. 操作系统通过几个基本的抽象概念（进程、虚拟内存和文件）来实现这两个功能
        1. 文件是对 I/O 设备的抽象表示
        1. 虚拟内存是对主存和磁盘 I/O 设备的抽象表示
        1. 进程是对处理器、主存和 I/O 设备的抽象表示
    1. 进程
        1. 对于一个程序，操作系统会提供一种假象，好像系统上只有这个程序在运行。程序看上去是独占地使用处理器、主存和 I/O 设备
            1. 处理器就像在不间断地一条接一条地执行程序中的指令，即该程序的代码和数据是系统内存中唯一的对象
            1. 这些假象是通过进程的概念来实现的，进程是计算机科学中最重要和最成功的概念之一
        1. 进程是操作系统对一个正在运行的程序的一种抽象
            1. 传统系统在一个时刻只能执行一个程序，而先进的多核处理器同时能执行多个程序
            1. 无论是在单核还是多核系统中，一个 CPU 看上去都像是在并发地执行多个进程，这是通过处理器在进程间切换来实现的
            1. 操作系统实现这种交错执行的机制称为**上下文切换**
        1. 操作系统保持跟踪进程运行所需的所有状态信息，也就是上下文。包括 PC 和寄存器文件的当前值，以及主存的内容等信息
            1. 当操作系统决定要把控制权从当前进程转移到某个新进程时，就会进行上下文切换，即保存当前进程的上下文、恢复新进程的上下文，然后将控制权传递到新进程
        1. 从一个进程到另一个进程的转换是由操作系统**内核**（kernel）管理的
            1. 内核是操作系统代码常驻主存的部分
            1. 当应用程序需要操作系统的某些操作时，比如读写文件，它就执行一条特殊的**系统调用**（system call）指令，将控制权传递给内核
            1. 内核不是一个独立的进程。相反，它是系统管理全部进程所用代码和数据结构的集合
        1. 实现进程这个抽象概念需要低级硬件和操作系统软件之间的紧密合作
    1. 线程
        1. 在现代系统中，一个进程可以由多个称为**线程**的执行单元组成
        1. 每个线程都运行在进程的上下文中，并共享同样的代码和全局数据
    1. 虚拟内存
        1. 虚拟内存时一个抽象概念，它为每个进程提供了一个假象，即每个进程都在独占地使用主存
        1. 每个进程看到的内存都是一致的，称为**虚拟地址空间**
        1. 每个进程看到的虚拟地址空间由大量准确定义的区构成，每个区都有专门的功能，以下区从最低的地址开始，逐步向上
            1. 程序代码和数据
                1. 对所有进程来说，代码是从同一固定地址开始，紧接着的是和 C 全局变量相对应的数据位置
                1. 代码和数据区在进程一开始运行时就被指定了大小
            1. 堆
                1. 调用 C 标准库的 malloc 和 free 等函数，堆可以在运行时动态地扩展和收缩
            1. 共享库
                1. 存放像 C 标准库和数学库这样的共享库的代码和数据的区域
            1. 栈
                1. 位于用户虚拟地址空间顶部，编译器用它来实现函数调用
                1. 和堆一样，用户栈在程序执行期间可以动态扩展和收缩
                1. 每次调用一个函数，栈就会增长；从一个函数返回时，栈就会收缩
            1. 内核虚拟内存
                1. 地址空间顶部的区域是为内核保留的，不允许应用程序读写这个区域的内容或直接调用内核代码定义的函数
                1. 应用程序必须调用内核来执行这些操作
        1. 虚拟内存的运作需要硬件和操作系统软件之间精密复杂的交互，包括对处理器生成的每个地址的硬件翻译
        1. 基本思想是把一个进程虚拟内存的内容存储在磁盘上，然后用主存作为磁盘的高速缓存
    1. 文件
        1. 文件就是字节序列，仅此而已
        1. 每个 I/O 设备，包括磁盘、键盘、显示器，甚至网络，都可以看成是文件
        1. 系统中的所有输入输出都是通过使用一小组称为 Unix I/O 的系统函数调用读写文件来实现的
        1. 文件这个概念向应用程序提供了一个统一的视图，来看待系统中可能含有的所有各式各样的 I/O 设备
1. 系统之间利用网络通信
    1. 从一个单独的系统来看，网络可视为一个 I/O 设备
    1. 系统从主存复制一串字节到网络适配器时，数据流经过网络到达另一台机器
    1. 系统可以读取从其他机器发送来的数据，并把数据复制到自己的主存
1. 重要主题
    1. 系统是硬件和系统软件相互交织的集合体，它们必须共同协作以达到运行应用程序的最终目的
    1. Amdahl 定律
        1. 当我们对系统的某个部分加速时，其对系统整体性能的影响取决于该部分的重要性和加速程度
        1. 要想显著加速整个系统，必须提升全系统中相当大的部分的速度
        1. 如果 60% 的系统能够加速到不花时间的程度，我们获得的净加速比将仍只有 2.5
        1. 性能提升 2 倍或更高的比例因子只有通过优化系统的大部分组件才能获得
    1. 并发和并行
        1. 并发（concurrency）是一个通用的概念，指一个同时具有多个活动的系统
        1. 并行（parallelism）指的是用并发来使一个系统运行得更快
        1. 线程级并发
            1. 单处理器
                1. 通过进程间快速切换模拟并发执行
            1. 多处理器
                1. 多核
                    1. 将多个 CPU（称为核） 集成到一个集成电路芯片上
                    1. 每个核都有自己的 L1 和 L2 高速缓存
                    1. 其中 L1 高速缓存分为 L1 指令高速缓存，保存最近取到的指令；还有 L1 指令高速缓存，存放数据
                    1. 这些核共享更高层次的高速缓存（如 L3 高速缓存)，以及到主存的接口
                1. 超线程（hyperthreading）
                    1. 也称为同时多线程（simultaneous multi-threading)
                    1. 是一项允许一个 CPU 执行多个控制流的技术
                    1. 常规的处理器需要大约20000个时钟周期做不同线程间的转换，而超线程的处理器可以在单个周期的基础上决定要执行哪一个线程
                    1. 多核和超线程的出现极大地激发了找到利用硬件开发线程级并行性应用程序的方法的愿望
        1. 指令级并行
            1. 在较低的抽象层次上，现代处理器可以同时执行多条指令的属性称为**指令级并行**
            1. 处理器使用了流水线（pipelining）等非常多的聪明的技巧来同时处理多条指令
            1. 如果处理器可以达到比一个周期一条指令更快的执行速率，就称之为**超标量**（superscalar）处理器
        1. 单指令、多数据并行
            1. 在最低层次上，许多现代处理器拥有特殊的硬件，允许一条指令产生多个可以并行执行的操作
            1. 这种方式称为**单指令、多数据**，即 SIMD（Single Instruction, Multiple Data） 并行
            1. 使用编译器支持的特殊的向量数据类型来写程序，比如 GCC 就支持向量数据类型
            1. Modern CPUs have advanced SIMD operation support such as AVX2, AVX3 which provide SIMD (instructions) acceleration
    1. 计算机系统中抽象的重要性
        1. **抽象**的使用是计算机科学中最为重要的概念之一
        1. 在处理器里，**指令集架构**提供了对实际处理器硬件的抽象
        1. **虚拟机**提供对整个计算机的抽象，包括操作系统、处理器和程序
